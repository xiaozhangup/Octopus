From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Daniel Zhang <xiaozhangshiw@163.com>
Date: Tue, 28 Jan 2025 18:03:34 +0800
Subject: [PATCH] Add EntityPortalPreparedEvent


diff --git a/src/main/java/net/minecraft/world/level/block/EndPortalBlock.java b/src/main/java/net/minecraft/world/level/block/EndPortalBlock.java
index 28d8c8a879badc97cd1168e1847e2fafdc40e4bd..b23a468b6f3e2c36531112bf3a8c558ad6a7771c 100644
--- a/src/main/java/net/minecraft/world/level/block/EndPortalBlock.java
+++ b/src/main/java/net/minecraft/world/level/block/EndPortalBlock.java
@@ -29,6 +29,7 @@ import net.minecraft.world.phys.shapes.VoxelShape;
 // CraftBukkit start
 import java.util.List;
 import org.bukkit.Location;
+import org.bukkit.PortalType;
 import org.bukkit.craftbukkit.CraftWorld;
 import org.bukkit.craftbukkit.event.CraftPortalEvent;
 import org.bukkit.craftbukkit.util.CraftLocation;
@@ -94,6 +95,12 @@ public class EndPortalBlock extends BaseEntityBlock implements Portal {
 
     @Override
     public DimensionTransition getPortalDestination(ServerLevel world, Entity entity, BlockPos pos) {
+        // Octopus start - Add EntityPortalPreparedEvent
+        org.bukkit.event.entity.EntityPortalPreparedEvent portalPreparedEvent = new org.bukkit.event.entity.EntityPortalPreparedEvent(entity.getBukkitEntity(), PortalType.ENDER);
+        if (!portalPreparedEvent.callEvent()) {
+            return null;
+        }
+        // Octopus end - Add EntityPortalPreparedEvent
         ResourceKey<Level> resourcekey = world.getTypeKey() == LevelStem.END ? Level.OVERWORLD : Level.END; // CraftBukkit - SPIGOT-6152: send back to main overworld in custom ends
         ServerLevel worldserver1 = world.getServer().getLevel(resourcekey);
 
diff --git a/src/main/java/net/minecraft/world/level/block/NetherPortalBlock.java b/src/main/java/net/minecraft/world/level/block/NetherPortalBlock.java
index d579132d1afd5c2edb9356c5601584bca2357f8f..258e2d9dc2cfb2483ccca9eb3b5d166aa3057889 100644
--- a/src/main/java/net/minecraft/world/level/block/NetherPortalBlock.java
+++ b/src/main/java/net/minecraft/world/level/block/NetherPortalBlock.java
@@ -10,6 +10,7 @@ import net.minecraft.core.Direction;
 import net.minecraft.core.particles.ParticleTypes;
 import net.minecraft.resources.ResourceKey;
 import net.minecraft.server.level.ServerLevel;
+import net.minecraft.server.level.ServerPlayer;
 import net.minecraft.sounds.SoundEvents;
 import net.minecraft.sounds.SoundSource;
 import net.minecraft.util.RandomSource;
@@ -138,6 +139,13 @@ public class NetherPortalBlock extends Block implements Portal {
     @Nullable
     @Override
     public DimensionTransition getPortalDestination(ServerLevel world, Entity entity, BlockPos pos) {
+        // Octopus start - Add EntityPortalPreparedEvent
+        org.bukkit.event.entity.EntityPortalPreparedEvent portalPreparedEvent = new org.bukkit.event.entity.EntityPortalPreparedEvent(entity.getBukkitEntity(), org.bukkit.PortalType.NETHER);
+        if (!portalPreparedEvent.callEvent()) {
+            entity.portalProcess = null;
+            return null;
+        }
+        // Octopus end - Add EntityPortalPreparedEvent
         // CraftBukkit start
         ResourceKey<Level> resourcekey = world.getTypeKey() == LevelStem.NETHER ? Level.OVERWORLD : Level.NETHER;
         ServerLevel worldserver1 = world.getServer().getLevel(resourcekey);
